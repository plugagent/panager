# --- Stage 0: Model Downloader ---
FROM ghcr.io/astral-sh/uv:python3.13-bookworm-slim AS downloader

WORKDIR /app

# 모델 다운로드를 위한 환경 변수 설정
ENV HF_HOME=/model-cache

# 모델 미리 다운로드
RUN uv run --with sentence-transformers python -c \
    "from sentence_transformers import SentenceTransformer; \
     SentenceTransformer('paraphrase-multilingual-mpnet-base-v2')"

# --- Stage 1: Final Image ---
FROM alpine:latest

WORKDIR /model

# 다운로드된 모델 복사
COPY --from=downloader /model-cache /model

# 모델 버전 파일 생성 (멱등성 보장용)
RUN date +%s > /model/.model_version

# 실행 시 볼륨으로 복사하는 명령
# /app/.cache/huggingface 경로가 볼륨으로 마운트될 것을 가정
CMD ["sh", "-ec", "mkdir -p /app/.cache/huggingface && if ! cmp -s /model/.model_version /app/.cache/huggingface/.model_version; then echo 'Model version mismatch or missing. Updating volume...'; cp -a /model/. /app/.cache/huggingface/ && chown -R 1000:1000 /app/.cache/huggingface; else echo 'Model version is up to date.'; fi && echo 'Done.'"]

# --- Stage 0: Model Downloader ---
FROM ghcr.io/astral-sh/uv:python3.13-bookworm-slim AS downloader

WORKDIR /app

# 모델 다운로드를 위한 환경 변수 설정
ENV HF_HOME=/model-cache

# 모델 미리 다운로드
RUN uv run --with sentence-transformers python -c \
    "from sentence_transformers import SentenceTransformer; \
     SentenceTransformer('paraphrase-multilingual-mpnet-base-v2')"

# --- Stage 1: Final Image ---
FROM alpine:latest

WORKDIR /model

# 다운로드된 모델 복사
COPY --from=downloader /model-cache /model

# 실행 시 볼륨으로 복사하는 명령
# /app/.cache/huggingface 경로가 볼륨으로 마운트될 것을 가정
CMD ["sh", "-c", "echo 'Copying model to volume...' && mkdir -p /app/.cache/huggingface && cp -a /model/. /app/.cache/huggingface/ && echo 'Done.'"]
